<!DOCTYPE <!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Assignment 2 - Zijie Lu</title>
    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
</head>
<body>
    <h1>Movie Rate and Popularity</h1>
    <div id="path">
        <script>
            var margin = {
                    top: 10,
                    bottom: 20,
                    left: 100,
                    right: 50
                };

                var width = 600;
                var height = 500;

            var xScale = d3.scale.linear()
                            .range([0, width - margin.left - margin.right])
                            .nice();

            var yScale = d3.scale.linear()
                            .range([height - margin.bottom - margin.top, 0])
                            .nice();

            var xSelection = "Popularity";
            var ySelection = "Rate";

            d3.csv("movies_rate.csv", function(data) {
                
                data.forEach(function (d) {
                    d[xSelection] = parseFloat(d[xSelection]);
                    d[ySelection] = parseFloat(d[ySelection]);
                });

                /*--- Create layers ---*/
                var layer1 = d3.select("#path")
                            .append("svg")
                            .attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom)
                
                var layer2 = layer1.append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                                .append("svg")
                                .attr("width", width)
                                .attr("height", height);

                /*--- Set the scales ---*/
                xScale.domain([0, 1.05 * d3.max(data, function(d) {
                                        return d[xSelection];
                                    })]);

                var xAxis = d3.svg.axis()
                                // .scale(xScale)
                                .orient("bottom")
                                .ticks(5)
                                .tickFormat(function(d) {
                                    if (xSelection.includes('Rate')) {
                                        return d3.format(".2f")(d * 100) + "%";
                                    } else if (xSelection.includes('mortaility')) {
                                        return d3.format(".2f")(d * 100) + "%";
                                    } else if (xSelection.includes("%")) {
                                        return d3.format(".2f")(d) + "%";
                                    } else {
                                        return d;
                                    }
                                });
                xAxis.scale(xScale);    

                yScale.domain([0, 1.05 * d3.max(data, function(d) {
                                        return d[ySelection];
                                    })]);
                            
                var yAxis = d3.svg.axis()
                                // .scale(yScale)
                                .orient("left")
                                .ticks(5)
                                .tickFormat(function(d) {
                                    if (ySelection.includes('Rate')) {
                                        return d3.format(".2f")(d * 100) + "%";
                                    } else if (ySelection.includes('mortaility')) {
                                        return d3.format(".2f")(d * 100) + "%";
                                    } else if (ySelection.includes("%")) {
                                        return d3.format(".2f")(d) + "%";
                                    } else {
                                        return d;
                                    }
                                });
                                
                yAxis.scale(yScale);
                /*--- create zoom ---*/
                var zoomBeh = d3.behavior.zoom()
                                 .x(xScale)
                                 .y(yScale)
                                .scaleExtent([0.8, 5])
                                .on("zoom", zoom);   

                /*--- Assemble axes into figures ---*/
                layer1.append('g')
                   .attr('class', 'x axis')
                   .attr('id', 'xAxis')
                   .attr('transform', 'translate(' + margin.left + ',' + (height - margin.bottom) + ")")
                   .call(xAxis)
                   .append("text")
                   .attr('id', 'xAxisLabel')
                   .attr("x", width - margin.right)
                   .attr("text-anchor", "end")
                   .text(xSelection);

                layer1.append('g')
                   .attr('class', 'y axis')
                   .attr('id', 'yAxis')
                   .attr('transform', 'translate(' + margin.left + ',' + margin.bottom + ")")
                   .call(yAxis)
                   .append("text")
                   .attr("id", "yAxisLabel")
                   .attr("text-anchor", "end")
                   .attr("y", 10)
                   .attr("transform", "rotate(-90)")
                   .text(ySelection);
                
                layer1.call(zoomBeh);
                layer2.call(zoomBeh);    

                /*--- Draw the dots ---*/
                var genre = function(d) {
                    return d["1st Genre"];
                }

                var color = d3.scale.category10();

                var dots = layer2.selectAll(".dot")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", "dot")
                    .attr("r", 5)
                    .attr("cx", function(d) {
                        return xScale(d[xSelection]);
                    })
                    .attr("cy", function(d) {
                        return yScale(d[ySelection]);   
                    })
                    .style("fill", function(d) {
                        return color(genre(d));
                    })
                    .on('mouseover', function () {
                        d3.select(this)
                        .transition()
                        .duration(500)
                        .attr('r',10)
                        .attr('stroke-width',3)
                    })
                    .on('mouseout', function () {
                        d3.select(this)
                        .transition()
                        .duration(500)
                        .attr('r',5)
                        .attr('stroke-width',1)
                    })
                    // .attr("transform", transform);
                
                /*--- create legends ---*/ 
                var legend = layer1.selectAll(".legend")
                                .data(color.domain())
                                .enter()
                                .append("g")
                                .attr("class", "legend")
                                .attr("transform", function(d, i) {
                                    return "translate(0,  " + i * 15 + ")";
                                });
                
                legend.append("rect")
                      .attr("x", width - 50 )
                      .attr("width", 20)
                      .attr("height", 13)
                      .style("fill", color);
                
                legend.append("text")
                      .attr("x", width - 50 + 25)
                      .attr("y", 11)
                      .text(function(d) {
                          return d;
                      });
                      
                /*--- create menu ---*/
                var variable = ["Popularity", "Rate", "Year"];
                
                var x_menu = d3.select("body")
                            .append("left-div")
                            .attr("id", "menu");
                var x_text = x_menu.append('span')
                                .text("Select X-Axis variable");
                var x_options = x_menu.append('select')
                                    .attr('id', 'options')
                                    .on('change', changeX)
                                    .selectAll('option')
                                    .data(variable)
                                    .enter()
                                    .append('option')
                                    .attr('value', function(d) {
                                        return d;
                                    })
                                    .text(function(d) {
                                        return d;
                                    });

                var y_menu = d3.select("body")
                            .append("right-div")
                            .attr("id", "menu");
                var y_text = y_menu.append('span')
                                .text("Select Y-Axis variable");
                var y_options = y_menu.append('select')
                                    .attr('id', 'options')
                                    .on('change', changeY)
                                    .selectAll('option')
                                    .data(variable)
                                    .enter()
                                    .append('option')
                                    .attr('value', function(d) {
                                        return d;
                                    })
                                    .text(function(d) {
                                        return d;
                                    });

                /*--- change y-axis ---*/
                function changeY() {
                    ySelection = this.value;
                    yScale.domain([d3.min(data, function(d) {
                        return parseFloat(d[ySelection])
                    }),
                    1.05 * d3.max(data,function(d) { 
                        return parseFloat(d[ySelection]); 
                        })
                    ])
                    yAxis.scale(yScale)
                        .tickFormat(function(d) {
                            if (ySelection.includes('Rate')) {
                                return d3.format(".2f")(d * 100) + "%";
                            } else if (ySelection.includes('mortaility')) {
                                return d3.format(".2f")(d * 100) + "%";
                            } else if (ySelection.includes("%")) {
                                return d3.format(".2f")(d) + "%";
                            } else {
                                return d;
                            }
                        });
                    d3.select('#yAxis')
                        .transition()
                        .duration(1000)
                        .call(yAxis);
                    d3.select('#yAxisLabel')
                        .text(ySelection);
                    d3.selectAll('.dot')
                        .call(function() {
                            var newZoombeh = d3.behavior.zoom()
                                .x(xScale)
                                .y(yScale)
                                .scaleExtent([0.8, 5])
                                .on("zoom", function(){
                                    layer1.select("#xAxis").call(xAxis);
                                    layer1.select("#yAxis").call(yAxis);
                                    layer2.selectAll("circle")
                                        .attr("transform", transform);
                                });
                            layer1.call(newZoombeh);
                        })
                        .transition()
                        .duration(1000)
                        // .delay(function(d, i) {
                        //     return (i * 10);
                        // })
                        .attr('cy', function(d) {
                            return yScale(parseFloat(d[ySelection]));
                        });
                }

                function changeX() {
                    xSelection = this.value;
                    xScale.domain([d3.min(data, function(d) {
                                return parseFloat(d[xSelection]);
                            }),
                    1.05 * d3.max(data,function (d) { 
                        return parseFloat(d[xSelection]);
                        })
                    ])
                    xAxis.scale(xScale)
                        .tickFormat(function(d) {
                            if (xSelection.includes('Rate')) {
                                return d3.format(".2f")(d * 100) + "%";
                            } else if (xSelection.includes('mortaility')) {
                                return d3.format(".2f")(d * 100) + "%";
                            } else if (xSelection.includes("%")) {
                                return d3.format(".2f")(d) + "%";
                            } else {
                                return d;
                            }
                        });
                    
                    d3.select('#xAxis')
                        .transition()
                        .duration(1000)
                        .call(xAxis);
                    d3.select('#xAxisLabel')
                        .text(xSelection);
                    d3.selectAll('circle')
                        .transition()
                        .duration(1000)
                        // .delay(function(d, i) {
                        //     return (i * 10);
                        // })
                        .attr('cx', function(d) {
                            return xScale(parseFloat(d[xSelection]));
                        })
                        .call(function() {
                            var newZoombeh = d3.behavior.zoom()
                                .x(xScale)
                                .y(yScale)
                                .scaleExtent([0.8, 5])
                                .on("zoom", function(){
                                    layer1.select("#xAxis").call(xAxis);
                                    layer1.select("#yAxis").call(yAxis);
                                    layer2.selectAll("circle")
                                        .attr("transform", transform);
                                });
                            layer1.call(newZoombeh);
                        });
                        
                }

                function zoom() {
                    layer1.select("#xAxis")
                            .call(xAxis);
                    layer1.select("#yAxis")
                            .call(yAxis);
                    
                    layer2.selectAll(".dot")
                        .attr("transform", transform);
                }

                function transform(d) {
                    return "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")";
            }

            });
        </script>
    </div>
</body>
</html>>